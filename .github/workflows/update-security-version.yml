name: Update SECURITY.md on version tag

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  update-security-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Update SECURITY.md version block
        run: |
          VERSION="${VERSION}"
          awk -v ver="$VERSION" '
          /<!-- SECURITY_VERSION_START -->/ {
              print "<!-- SECURITY_VERSION_START -->"
              print "| Version | Supported |"
              print "|--------|-----------|"
              print "| " ver " (latest) | ✅ Yes |"
              print "| < " ver " | ❌ No |"
              print "<!-- SECURITY_VERSION_END -->"
              skip=1
              next
          }
          /<!-- SECURITY_VERSION_END -->/ { skip=0; next }
          !skip { print }
          ' SECURITY.md > temp.md

          mv temp.md SECURITY.md

      - name: Commit and push changes (if modified)
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add SECURITY.md
          git diff --cached --quiet || git commit -m "DOCS: update supported version to v${VERSION}"
          git push
